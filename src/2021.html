<!-- Start 2021.html -->
<script
    src="https://cdn.jsdelivr.net/gh/TencentCloudBase/cloudbase-js-sdk@master/cdnjs/1.3.3/cloudbase.functions.js"></script>
<script>
    const app = cloudbase.init({
        env: "xhemj-0gjckebwf7276129"
    });
    const auth = app.auth();
    async function login() {
        await auth.anonymousAuthProvider().signIn();
        const loginState = await auth.getLoginState();
        console.log(loginState.isAnonymousAuth);
    };
    login();
    $.getJSON("https://api.ip.sb/geoip?callback=?",
        function (json) {
            var ip = json.ip;
            var country = json.country
            var region = json.region;
            var city = json.city;
            async function db() {
                app
                    .callFunction({
                        name: "mingyan",
                        data: {
                            event: "list"
                        }
                    })
                    .then((res) => {
                        console.log(res);
                        console.log(res.result.res.data);
                        var data = res.result.res.data;
                        var num = data.length;
                        console.log(num);
                        swal({
                            title: `第${num + 1}个人！！`,
                            text: `恭喜你成为2021年第${num + 1}个查看名言的人！！`,
                            icon: "success",
                            content: {
                                element: "input",
                                attributes: {
                                    placeholder: "写个名字记录一下你是谁吧！",
                                    type: "text"
                                }
                            }
                        })
                            .then(name => {
                                if (!name) {
                                    var name = "一位不知道名字的访客"
                                };
                                app
                                    .callFunction({
                                        name: "mingyan",
                                        data: {
                                            event: "add",
                                            name: name,
                                            ip: ip,
                                            addr: `${country} ${region} ${city}`,
                                            num: `${num + 1}`
                                        }
                                    })
                                    .then((res) => {
                                        console.log(res);
                                    })

                            })
                    });


            };
            db()
        }
    );
    
</script>
<!-- End 2021.html -->